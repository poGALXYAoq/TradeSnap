# TradeSnap: 跨市场每日持仓与盈亏快照生成器

## 1. 项目目标
构建一个本地化的投资组合管理工具，能够融合 **A股 (CSV)**、**中国期货 (CSV)**、**港股 (截图)** 和 **外盘期货 (截图)** 的数据。
系统需要根据**昨日底仓**和**今日交易记录**，自动生成**今日持仓快照**和**今日已实现盈亏**。

## 2. 核心工作流
1.  **加载**: 读取 `portfolio.db` (或 JSON) 获取昨日持仓状态。
2.  **输入**: 用户上传 A股 CSV、期货 CSV 或 交易截图。
3.  **解析**: 
    - CSV: 使用 Pandas 清洗，处理空日期等脏数据。
    - 图片: 调用 Ollama (Qwen-VL) 提取结构化 JSON。
4.  **计算**: 
    - 更新持仓 (加权平均法更新成本)。
    - 计算当日已实现盈亏 (Realized P&L)。
5.  **输出**: 生成 Excel (`.xlsx`)，包含“持仓快照”和“盈亏明细”两个 Sheet。

---

## 3. 数据源处理规范 (Data Specs)

### A. 中国 A 股 (CSV)
* **输入样本**:
    ```csv
    成交日期,成交时间,证券代码,证券名称,操作,成交数量,成交均价,成交金额,市场类别...
    ,,000400,许继电气,卖出,57600,26.541,1528745,深圳Ａ...
    ,,000783,长江证券,卖出,244300,8.24,2013032,深圳Ａ...
    ```
* **处理规则**:
    1.  **日期填充**: 若 `成交日期` 为空，默认为**运行当天的日期**。
    2.  **代码标准化**: 补全后缀 (e.g., `000400` -> `000400.SZ`, `600xxx` -> `600xxx.SH`)。
    3.  **逻辑**:
        - `操作` == '买入': 增加持仓，重新计算持仓均价。
        - `操作` == '卖出': 减少持仓，计算已实现盈亏。
        - **注意**: `成交均价` 是这一笔交易的价格，不是你的持仓成本。

### B. 中国期货 (CSV)
* **输入样本**:
    ```csv
    合约,买卖,开平,成交均价,成交手数,手续费,投保,平仓盈亏...
    IF2606,　卖,开仓,4688.8,10,325.42,投机,0...
    IH2603,买　,平仓,3139.86,25,545.66,投机,"-291,480.00"...
    ```
* **处理规则**:
    1.  **忽略字段**: 忽略 CSV 中的 `平仓盈亏`，必须重新计算。
    2.  **乘数 (Multiplier)**: 代码中必须包含合约乘数映射表：
        - IF (沪深300): 300
        - IH (上证50): 300
        - IC (中证500): 200
        - IM (中证1000): 200
        - *其他商品期货需预留接口*
    3.  **逻辑**:
        - `开仓`: 增加持仓手数。
        - `平仓`: 减少持仓，计算盈亏 = `(卖价 - 买价) * 乘数 * 手数 - 手续费` (注意方向)。

### C. 港股/外盘期货 (截图 -> AI)
* **输入**: 交易软件截图。
* **处理**: 调用 Ollama 接口，返回 JSON。
* **逻辑**: 标准化为与 CSV 解析后相同的数据结构。

---

## 4. 核心计算逻辑 (Business Logic)

### 持仓更新算法 (加权平均法)
系统维护一个 `Position` 对象：
- `symbol`: 代码
- `quantity`: 当前持仓量
- `avg_cost`: 持仓均价 (成本)

**当发生【买入/开仓】时**:
$$ NewCost = \frac{(OldQty \times OldCost) + (TradeQty \times TradePrice)}{OldQty + TradeQty} $$
$$ NewQty = OldQty + TradeQty $$

**当发生【卖出/平仓】时**:
$$ RealizedPnL = (TradePrice - OldCost) \times TradeQty - Fees $$
$$ NewQty = OldQty - TradeQty $$
*(注：卖出不改变剩余持仓的单位成本，除非清仓)*

### 输出格式 (Excel)

**Sheet 1: 当日持仓快照 (Snapshot)**
| 股票名称 | 股票代码 | 持仓量 | 持仓均价 | 收盘价(API/预留) | 占用金额 | 浮动盈亏 |
| :--- | :--- | :--- | :--- | :--- | :--- | :--- |
| 许继电气 | 000400.SZ | 1000 | 25.00 | 26.00 | 25000 | 1000 |

**Sheet 2: 当日已实现盈亏 (Realized PnL)**
| 时间 | 代码 | 名称 | 方向 | 数量 | 成交均价 | 成本价 | 产生的盈亏 |
| :--- | :--- | :--- | :--- | :--- | :--- | :--- | :--- |

---

## 5. 技术栈与环境
* **Python**: 3.12+
* **UI**: Streamlit (用于上传文件/图片和展示结果)
* **AI**: `ollama` 库 (Model: `qwen3-vl:8b` )
* **Data**: Pandas, XlsxWriter
